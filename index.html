<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Manus AI v2.6 SPEED â€” Interfaz web para tu IA local"/>
<title>Manus AI v2.6</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700;800&family=Geist+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANUS AI v2.6 â€” INTERFAZ WEB COMPLETA
   Conecta a tu servidor local o en Railway
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:       #050508;
  --s0:       #08080e;
  --s1:       #0c0c14;
  --s2:       #10101a;
  --border:   #18182a;
  --hi:       #1e1e32;
  --a1:       #4ade80;  /* green */
  --a2:       #818cf8;  /* indigo */
  --a3:       #f472b6;  /* pink */
  --a4:       #fb923c;  /* orange */
  --text:     #e8e8f5;
  --muted:    #44445a;
  --soft:     #7878a0;
  --mono:     'Geist Mono', 'Fira Code', monospace;
  --sans:     'Geist', 'Segoe UI', sans-serif;
  --r:        12px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--sans);overflow:hidden}
::selection{background:rgba(74,222,128,.2);color:var(--a1)}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--hi);border-radius:999px}

/* â”€â”€ BG ATMOSPHERE â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 60% 40% at 5% 5%,   rgba(74,222,128,.05) 0%,transparent 60%),
    radial-gradient(ellipse 40% 60% at 95% 95%,  rgba(129,140,248,.06) 0%,transparent 60%),
    radial-gradient(ellipse 30% 50% at 50% 50%,  rgba(244,114,182,.03) 0%,transparent 70%);
}

/* â•â• APP SHELL â•â• */
.app{position:relative;z-index:1;display:flex;height:100vh}

/* â•â• SIDEBAR â•â• */
.sidebar{
  width:252px;min-width:252px;
  background:var(--s0);border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  transition:transform .3s cubic-bezier(.4,0,.2,1);
}
.sidebar-head{padding:20px 18px 14px;border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:center;gap:10px}
.logo-mark{
  width:34px;height:34px;border-radius:9px;
  background:linear-gradient(135deg,var(--a1),var(--a2));
  display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;
  box-shadow:0 0 16px rgba(74,222,128,.25);
  animation:glow 3s ease-in-out infinite;
}
@keyframes glow{0%,100%{box-shadow:0 0 10px rgba(74,222,128,.2)}50%{box-shadow:0 0 24px rgba(74,222,128,.4)}}
.logo-text{font-size:17px;font-weight:800;letter-spacing:-.5px}
.logo-text b{color:var(--a1)}
.logo-ver{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:1px;margin-top:1px}

.new-btn{
  margin:12px 16px 0;padding:9px 14px;
  background:transparent;border:1px solid var(--border);border-radius:8px;
  color:var(--soft);font-family:var(--sans);font-size:13px;font-weight:600;
  cursor:pointer;display:flex;align-items:center;gap:8px;
  transition:all .18s;
}
.new-btn:hover{border-color:var(--a1);color:var(--a1);background:rgba(74,222,128,.04)}

.search-wrap{padding:10px 14px}
.search{
  width:100%;padding:7px 12px;background:var(--s1);
  border:1px solid var(--border);border-radius:7px;
  color:var(--text);font-family:var(--mono);font-size:11px;outline:none;
  transition:border-color .18s;
}
.search::placeholder{color:var(--muted)}
.search:focus{border-color:var(--a2)}

.convs{flex:1;overflow-y:auto;padding:4px 10px}
.conv-group{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;padding:8px 6px 3px}
.conv-item{
  padding:8px 10px;border-radius:8px;cursor:pointer;
  display:flex;align-items:center;gap:8px;
  font-size:13px;color:var(--soft);
  transition:background .15s;margin-bottom:1px;
  position:relative;border-left:2px solid transparent;
}
.conv-item:hover{background:var(--s1);color:var(--text)}
.conv-item.active{background:rgba(74,222,128,.07);color:var(--text);border-left-color:var(--a1)}
.conv-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.conv-time{font-family:var(--mono);font-size:9px;color:var(--muted)}

.sidebar-foot{padding:14px 16px;border-top:1px solid var(--border)}
.user-row{
  display:flex;align-items:center;gap:10px;
  padding:7px 9px;border-radius:8px;cursor:pointer;
  transition:background .15s;
}
.user-row:hover{background:var(--s1)}
.avatar{
  width:30px;height:30px;border-radius:50%;
  background:linear-gradient(135deg,var(--a1),var(--a2));
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:#050508;flex-shrink:0;
}
.user-name{font-size:13px;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.logout{font-family:var(--mono);font-size:10px;color:var(--muted);background:none;border:none;cursor:pointer;transition:color .15s}
.logout:hover{color:var(--a3)}

/* â•â• MAIN â•â• */
.main{flex:1;display:flex;flex-direction:column;min-width:0}

/* topbar */
.topbar{
  padding:13px 24px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:14px;
  background:rgba(5,5,8,.8);backdrop-filter:blur(16px);
}
.menu-btn{background:none;border:none;cursor:pointer;color:var(--muted);transition:color .15s;display:none;padding:4px}
.menu-btn:hover{color:var(--text)}
.conv-name{
  flex:1;background:none;border:none;
  font-family:var(--sans);font-size:15px;font-weight:600;color:var(--text);
  outline:none;cursor:default;border-bottom:1px solid transparent;
  transition:border-color .18s;
}
.conv-name:focus{cursor:text;border-bottom-color:var(--border)}
.server-pill{
  display:flex;align-items:center;gap:6px;
  font-family:var(--mono);font-size:10px;
  border:1px solid var(--border);border-radius:999px;padding:4px 12px;
  color:var(--muted);transition:all .2s;cursor:pointer;
}
.server-pill:hover{border-color:var(--a2);color:var(--a2)}
.pill-dot{width:6px;height:6px;border-radius:50%;background:var(--muted)}
.pill-dot.on{background:var(--a1);animation:glow 2s infinite}
.topbar-btns{display:flex;gap:6px}
.top-btn{
  background:none;border:1px solid var(--border);border-radius:6px;
  padding:5px 10px;color:var(--muted);cursor:pointer;
  font-family:var(--mono);font-size:10px;
  display:flex;align-items:center;gap:5px;transition:all .18s;
}
.top-btn:hover{border-color:var(--a1);color:var(--a1)}

/* messages */
.msgs{
  flex:1;overflow-y:auto;
  padding:28px 32px;display:flex;flex-direction:column;gap:16px;
  scroll-behavior:smooth;
}

/* empty state */
.empty{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:20px;
  text-align:center;animation:fadeIn .5s ease;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.empty-icon{
  font-size:64px;
  filter:drop-shadow(0 0 28px rgba(74,222,128,.35));
  animation:float 4s ease-in-out infinite;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.empty-title{font-size:28px;font-weight:800;letter-spacing:-1.2px}
.empty-title span{color:var(--a1)}
.empty-sub{font-family:var(--mono);font-size:12px;color:var(--muted)}
.chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:520px}
.chip{
  padding:8px 16px;border:1px solid var(--border);border-radius:999px;
  font-size:13px;color:var(--soft);cursor:pointer;font-family:var(--mono);
  transition:all .18s;background:var(--s1);
}
.chip:hover{border-color:var(--a1);color:var(--a1);background:rgba(74,222,128,.06)}

/* message bubbles */
.msg{display:flex;gap:12px;animation:slideUp .28s ease;max-width:820px}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse;align-self:flex-end}
.msg.ai{align-self:flex-start}
.msg-av{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;margin-top:2px;
}
.msg.ai .msg-av{background:var(--s1);border:1px solid var(--border)}
.msg.user .msg-av{background:linear-gradient(135deg,var(--a1),var(--a2));color:#050508;font-weight:700;font-size:12px}
.msg-body{display:flex;flex-direction:column;gap:5px;max-width:calc(100% - 46px)}
.msg-meta{font-family:var(--mono);font-size:10px;color:var(--muted)}
.msg.user .msg-meta{text-align:right}
.bubble{
  padding:13px 17px;border-radius:var(--r);
  font-size:14px;line-height:1.75;word-break:break-word;
}
.msg.ai .bubble{
  background:var(--s1);border:1px solid var(--border);
  border-top-left-radius:3px;
}
.msg.user .bubble{
  background:var(--s2);border:1px solid var(--hi);
  border-top-right-radius:3px;
}
.bubble pre{
  background:rgba(0,0,0,.5);border:1px solid var(--border);
  border-radius:8px;padding:14px;overflow-x:auto;
  font-family:var(--mono);font-size:12px;margin:10px 0;line-height:1.65;
}
.bubble code:not(pre code){
  background:rgba(74,222,128,.1);color:var(--a1);
  padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:12px;
}
.bubble strong{color:#f0f0ff;font-weight:700}
.bubble h1,.bubble h2,.bubble h3{color:#f0f0ff;font-weight:700;margin:12px 0 6px;letter-spacing:-.3px}
.bubble h1{font-size:18px}.bubble h2{font-size:16px}.bubble h3{font-size:14px}
.bubble ul,.bubble ol{padding-left:18px;margin:6px 0}
.bubble li{margin:3px 0}
.bubble a{color:var(--a2);text-decoration:none}
.bubble a:hover{text-decoration:underline}
.bubble blockquote{border-left:3px solid var(--a1);padding-left:12px;color:var(--soft);margin:8px 0}
.bubble table{border-collapse:collapse;width:100%;margin:8px 0;font-size:13px}
.bubble th,.bubble td{border:1px solid var(--border);padding:6px 10px;text-align:left}
.bubble th{background:var(--s2);color:var(--a1);font-weight:600}

/* tools accordion */
.tools-wrap{border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:6px}
.tools-hd{
  width:100%;padding:7px 12px;background:rgba(74,222,128,.04);
  border:none;cursor:pointer;font-family:var(--mono);font-size:10px;
  color:var(--a1);display:flex;align-items:center;gap:6px;text-align:left;
  transition:background .15s;
}
.tools-hd:hover{background:rgba(74,222,128,.08)}
.tools-body{padding:8px 12px 12px;display:flex;flex-direction:column;gap:5px}
.tool-row{
  display:flex;align-items:flex-start;gap:8px;
  font-family:var(--mono);font-size:11px;color:var(--soft);
}
.tool-icon{flex-shrink:0;font-size:13px}
.tool-name{color:var(--a2);font-weight:500}
.tool-result{color:var(--a1);opacity:.8}

/* typing */
.typing{display:flex;gap:5px;align-items:center;padding:2px 0}
.typing span{
  width:7px;height:7px;border-radius:50%;background:var(--a1);
  animation:dot 1.2s infinite;opacity:.3;
}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes dot{40%{opacity:1;transform:scale(1.2)}}

/* input */
.input-area{
  padding:14px 24px 22px;
  background:rgba(5,5,8,.85);backdrop-filter:blur(16px);
  border-top:1px solid var(--border);
}
.input-box{
  background:var(--s1);border:1px solid var(--border);
  border-radius:var(--r);padding:13px 15px;
  display:flex;align-items:flex-end;gap:10px;
  transition:border-color .18s,box-shadow .18s;
}
.input-box:focus-within{border-color:var(--a1);box-shadow:0 0 0 3px rgba(74,222,128,.07)}
.msg-ta{
  flex:1;background:none;border:none;color:var(--text);
  font-family:var(--sans);font-size:14px;line-height:1.6;
  resize:none;outline:none;max-height:160px;min-height:22px;
}
.msg-ta::placeholder{color:var(--muted)}
.send{
  width:36px;height:36px;border-radius:9px;border:none;
  background:var(--a1);color:#050508;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;transition:all .18s;
}
.send:hover{background:#86efac;transform:scale(1.05)}
.send:disabled{background:var(--border);color:var(--muted);transform:none;cursor:not-allowed}
.hints{display:flex;gap:14px;margin-top:7px;padding:0 3px}
.hint{font-family:var(--mono);font-size:10px;color:var(--muted)}
.hint kbd{background:var(--s1);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:9px}

/* â•â• LOGIN â•â• */
.login-mask{
  position:fixed;inset:0;z-index:100;background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding:20px;animation:fadeIn .4s ease;
}
.login-card{
  width:100%;max-width:380px;background:var(--s1);
  border:1px solid var(--border);border-radius:20px;padding:36px;
  display:flex;flex-direction:column;gap:20px;
}
.login-head{text-align:center}
.login-icon{font-size:48px;display:block;margin-bottom:10px;animation:float 4s ease-in-out infinite}
.login-title{font-size:24px;font-weight:800;letter-spacing:-1px}
.login-title span{color:var(--a1)}
.login-ver{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:3px}
.field{display:flex;flex-direction:column;gap:5px}
.lbl{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.inp{
  background:var(--bg);border:1px solid var(--border);
  border-radius:9px;padding:11px 14px;
  color:var(--text);font-family:var(--sans);font-size:14px;
  outline:none;transition:border-color .18s;width:100%;
}
.inp:focus{border-color:var(--a1)}
.inp::placeholder{color:var(--muted)}
.server-row{display:flex;gap:8px}
.server-row .inp{flex:1}
.test-btn{
  background:var(--hi);border:1px solid var(--border);border-radius:9px;
  padding:0 14px;color:var(--soft);font-family:var(--sans);font-size:12px;
  font-weight:600;cursor:pointer;white-space:nowrap;transition:all .18s;flex-shrink:0;
}
.test-btn:hover{border-color:var(--a2);color:var(--a2)}
.login-btn{
  padding:13px;background:linear-gradient(135deg,var(--a1),var(--a2));
  color:#050508;border:none;border-radius:10px;
  font-family:var(--sans);font-size:15px;font-weight:800;
  cursor:pointer;transition:all .2s;letter-spacing:-.3px;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 28px rgba(74,222,128,.25)}
.login-btn:disabled{background:var(--border);color:var(--muted);transform:none;box-shadow:none;cursor:not-allowed}
.login-err{font-family:var(--mono);font-size:11px;color:var(--a3);text-align:center;padding:8px 12px;background:rgba(244,114,182,.06);border:1px solid rgba(244,114,182,.15);border-radius:8px;display:none}
.register-link{font-family:var(--mono);font-size:11px;color:var(--muted);text-align:center;cursor:pointer}
.register-link b{color:var(--a2);cursor:pointer}

/* â•â• MODALS â•â• */
.modal-bg{
  position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.7);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;padding:20px;
  animation:fadeIn .2s ease;
}
.modal{
  background:var(--s1);border:1px solid var(--border);
  border-radius:16px;padding:26px;width:100%;max-width:340px;
  display:flex;flex-direction:column;gap:14px;
}
.modal-title{font-size:16px;font-weight:700}
.export-btns{display:flex;gap:8px}
.ex-btn{
  flex:1;padding:10px;border:1px solid var(--border);
  border-radius:8px;background:none;color:var(--text);
  cursor:pointer;font-family:var(--mono);font-size:11px;
  transition:all .18s;
}
.ex-btn:hover{border-color:var(--a1);color:var(--a1)}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;align-self:flex-end;margin-top:-6px;line-height:1}
.modal-close:hover{color:var(--a3)}

/* â•â• TOAST â•â• */
.toast{
  position:fixed;bottom:28px;right:24px;z-index:500;
  background:var(--s1);border:1px solid var(--a1);border-radius:10px;
  padding:11px 18px;font-family:var(--mono);font-size:12px;color:var(--a1);
  box-shadow:0 4px 28px rgba(74,222,128,.15);animation:slideUp .3s ease;
  display:flex;align-items:center;gap:8px;
}
.toast.err{border-color:var(--a3);color:var(--a3);box-shadow:0 4px 28px rgba(244,114,182,.1)}
.toast.hide{animation:fadeOut .3s ease forwards}
@keyframes fadeOut{to{opacity:0;transform:translateY(8px)}}

/* â•â• SHORTCUTS â•â• */
.sc-card{
  background:var(--s1);border:1px solid var(--border);
  border-radius:16px;padding:26px;width:100%;max-width:360px;
  display:flex;flex-direction:column;gap:10px;
}
.sc-row{display:flex;justify-content:space-between;align-items:center;font-size:13px}
.sc-row kbd{
  background:var(--hi);border:1px solid var(--border);border-radius:5px;
  padding:3px 8px;font-family:var(--mono);font-size:10px;color:var(--a1);
}

/* â•â• SPEED BADGE â•â• */
.speed-badge{
  display:inline-flex;align-items:center;gap:5px;
  font-family:var(--mono);font-size:9px;color:var(--a4);
  border:1px solid rgba(251,146,60,.2);border-radius:999px;padding:2px 8px;
  background:rgba(251,146,60,.05);
}

/* â•â• RESPONSIVE â•â• */
@media(max-width:680px){
  .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:50;transform:translateX(-100%)}
  .sidebar.open{transform:none;box-shadow:4px 0 30px rgba(0,0,0,.6)}
  .menu-btn{display:flex!important}
  .msgs{padding:16px 14px}
  .input-area{padding:10px 14px 18px}
  .topbar{padding:12px 14px}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="login-mask" id="loginMask">
  <div class="login-card">
    <div class="login-head">
      <span class="login-icon">â¬¡</span>
      <div class="login-title">Manus <span>AI</span></div>
      <div class="login-ver">v2.6 SPEED Â· <span class="speed-badge">âš¡ 3x mÃ¡s rÃ¡pido</span></div>
    </div>

    <div class="field">
      <div class="lbl">Servidor</div>
      <div class="server-row">
        <input class="inp" id="srvUrl" value="http://localhost:3000" placeholder="http://localhost:3000"/>
        <button class="test-btn" onclick="testServer()">Probar</button>
      </div>
    </div>

    <div class="field">
      <div class="lbl">Email</div>
      <input class="inp" id="loginEmail" type="email" placeholder="tu@email.com" autocomplete="username"/>
    </div>
    <div class="field">
      <div class="lbl">ContraseÃ±a</div>
      <input class="inp" id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>

    <div class="login-err" id="loginErr"></div>

    <button class="login-btn" id="loginBtn" onclick="doLogin()">
      Entrar â†’
    </button>
    <div class="register-link" onclick="showRegister()">Â¿Sin cuenta? <b>RegÃ­strate aquÃ­</b></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• REGISTER MODAL â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="registerModal" style="display:none" onclick="closeRegister(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeRegister()">âœ•</button>
    <div class="modal-title">Crear cuenta</div>
    <div class="field">
      <div class="lbl">Nombre</div>
      <input class="inp" id="regName" placeholder="Tu nombre"/>
    </div>
    <div class="field">
      <div class="lbl">Email</div>
      <input class="inp" id="regEmail" type="email" placeholder="tu@email.com"/>
    </div>
    <div class="field">
      <div class="lbl">ContraseÃ±a (mÃ­n. 6 caracteres)</div>
      <input class="inp" id="regPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
    </div>
    <div class="login-err" id="regErr" style="display:none"></div>
    <button class="login-btn" id="regBtn" onclick="doRegister()">Crear cuenta â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app" id="app" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-head">
      <div class="logo">
        <div class="logo-mark">â¬¡</div>
        <div>
          <div class="logo-text">Manus <b>AI</b></div>
          <div class="logo-ver">v2.6 SPEED <span class="speed-badge">âš¡</span></div>
        </div>
      </div>
    </div>

    <button class="new-btn" onclick="newChat()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Nueva conversaciÃ³n
    </button>

    <div class="search-wrap">
      <input class="search" id="searchConv" placeholder="Buscarâ€¦" oninput="filterConvs(this.value)"/>
    </div>

    <div class="convs" id="convList">
      <div style="font-family:var(--mono);font-size:11px;color:var(--muted);padding:10px 8px">Cargandoâ€¦</div>
    </div>

    <div class="sidebar-foot">
      <div class="user-row">
        <div class="avatar" id="userAv">?</div>
        <div class="user-name" id="userNameEl">â€”</div>
        <button class="logout" onclick="doLogout()">salir</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- topbar -->
    <div class="topbar">
      <button class="menu-btn" onclick="toggleSidebar()">
        <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <input class="conv-name" id="convName" value="Nueva conversaciÃ³n" readonly onblur="saveConvName(this.value)" onfocus="this.removeAttribute('readonly')"/>
      <div class="server-pill" id="serverPill" onclick="promptServer()">
        <div class="pill-dot" id="pillDot"></div>
        <span id="pillLabel">desconectado</span>
      </div>
      <div class="topbar-btns">
        <button class="top-btn" onclick="openExport()">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          Exportar
        </button>
        <button class="top-btn" onclick="showShortcuts()">âŒ¨ï¸</button>
      </div>
    </div>

    <!-- messages -->
    <div class="msgs" id="msgsArea">
      <div class="empty" id="emptyState">
        <div class="empty-icon">â¬¡</div>
        <div class="empty-title">Â¿En quÃ© puedo<br/><span>ayudarte?</span></div>
        <div class="empty-sub">Manus AI v2.6 Â· 12 herramientas Â· âš¡ 3x mÃ¡s rÃ¡pido</div>
        <div class="chips">
          <div class="chip" onclick="sendChip(this)">ğŸ” Busca informaciÃ³n sobreâ€¦</div>
          <div class="chip" onclick="sendChip(this)">ğŸ’» Escribe cÃ³digo paraâ€¦</div>
          <div class="chip" onclick="sendChip(this)">ğŸ“Š Analiza estos datosâ€¦</div>
          <div class="chip" onclick="sendChip(this)">ğŸ—‚ï¸ Genera un proyectoâ€¦</div>
          <div class="chip" onclick="sendChip(this)">ğŸ™ï¸ Crea audio de textoâ€¦</div>
          <div class="chip" onclick="sendChip(this)">ğŸ¬ Genera un video deâ€¦</div>
        </div>
      </div>
    </div>

    <!-- input -->
    <div class="input-area">
      <div class="input-box">
        <textarea class="msg-ta" id="msgInput" rows="1"
          placeholder="Escribe tu mensajeâ€¦ (Enter envÃ­a, Shift+Enter = nueva lÃ­nea)"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send" id="sendBtn" onclick="sendMsg()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
      <div class="hints">
        <span class="hint"><kbd>Enter</kbd> enviar</span>
        <span class="hint"><kbd>Shift+Enter</kbd> nueva lÃ­nea</span>
        <span class="hint"><kbd>Ctrl+N</kbd> nuevo chat</span>
        <span class="hint"><kbd>Ctrl+B</kbd> sidebar</span>
        <span style="margin-left:auto;font-family:var(--mono);font-size:10px;color:var(--muted)" class="speed-badge">âš¡ v2.6 SPEED</span>
      </div>
    </div>
  </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Export -->
<div class="modal-bg" id="exportModal" style="display:none" onclick="closeExport(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeExport()">âœ•</button>
    <div class="modal-title">Exportar conversaciÃ³n</div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--muted)">Elige formato:</div>
    <div class="export-btns">
      <button class="ex-btn" onclick="doExport('json')">ğŸ“¦ JSON</button>
      <button class="ex-btn" onclick="doExport('txt')">ğŸ“„ TXT</button>
      <button class="ex-btn" onclick="doExport('md')">ğŸ“ MD</button>
    </div>
  </div>
</div>

<!-- Shortcuts -->
<div class="modal-bg" id="scModal" style="display:none" onclick="closeModal('scModal',event)">
  <div class="sc-card">
    <div style="font-size:16px;font-weight:700;margin-bottom:4px">Atajos âŒ¨ï¸</div>
    <div class="sc-row"><span>Nuevo chat</span><kbd>Ctrl/âŒ˜ + N</kbd></div>
    <div class="sc-row"><span>Toggle sidebar</span><kbd>Ctrl/âŒ˜ + B</kbd></div>
    <div class="sc-row"><span>Buscar chats</span><kbd>Ctrl/âŒ˜ + K</kbd></div>
    <div class="sc-row"><span>Exportar</span><kbd>Ctrl/âŒ˜ + E</kbd></div>
    <div class="sc-row"><span>Atajos</span><kbd>Ctrl/âŒ˜ + /</kbd></div>
    <div class="sc-row"><span>Enviar mensaje</span><kbd>Enter</kbd></div>
    <div class="sc-row"><span>Cerrar modal</span><kbd>Esc</kbd></div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px">Click fuera para cerrar</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let SERVER = localStorage.getItem('ms_srv') || 'http://localhost:3000';
let convs = [], currentConvId = null, currentUser = null, busy = false;

document.getElementById('srvUrl').value = SERVER;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRPC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function trpc(proc, input, mut = false) {
  const url = `${SERVER}/api/trpc/${proc}`;
  const opts = mut
    ? { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(input ?? {}) }
    : { credentials: 'include' };
  const fullUrl = mut ? url : url + (input !== undefined ? `?input=${encodeURIComponent(JSON.stringify(input))}` : '');
  const r = await fetch(fullUrl, opts);
  const j = await r.json();
  if (j.error) throw new Error(j.error.message || 'Error');
  return j.result?.data ?? j.result;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SERVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testServer() {
  const url = document.getElementById('srvUrl').value.trim().replace(/\/$/, '');
  SERVER = url; localStorage.setItem('ms_srv', url);
  try {
    await fetch(`${url}/api/trpc/auth.me`, { credentials: 'include' });
    toast('âœ… Servidor conectado');
  } catch { toast('âŒ Sin conexiÃ³n al servidor', true); }
}

async function setServerStatus(ok) {
  const dot = document.getElementById('pillDot');
  const lbl = document.getElementById('pillLabel');
  dot.className = 'pill-dot' + (ok ? ' on' : '');
  lbl.textContent = ok ? SERVER.replace('http://', '').replace('https://', '') : 'desconectado';
}

function promptServer() {
  const url = prompt('URL del servidor:', SERVER);
  if (url) { SERVER = url.trim().replace(/\/$/, ''); localStorage.setItem('ms_srv', SERVER); document.getElementById('srvUrl').value = SERVER; testServer(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  SERVER = document.getElementById('srvUrl').value.trim().replace(/\/$/, '');
  localStorage.setItem('ms_srv', SERVER);
  if (!email || !pass) { showErr('Completa email y contraseÃ±a'); return; }
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Conectandoâ€¦';
  hideErr();
  try {
    const r = await fetch(`${SERVER}/api/auth/login`, {
      method: 'POST', credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass }),
    });
    if (!r.ok) {
      const j = await r.json().catch(() => ({}));
      throw new Error(j.error || 'Credenciales incorrectas');
    }
    const me = await trpc('auth.me');
    if (!me) throw new Error('No se pudo verificar sesiÃ³n');
    onLoginOk(me);
  } catch(e) { showErr(e.message); }
  finally { btn.disabled = false; btn.innerHTML = 'Entrar â†’'; }
}

async function doRegister() {
  const name  = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass  = document.getElementById('regPass').value;
  if (!email || !pass) { showRegErr('Email y contraseÃ±a requeridos'); return; }
  const btn = document.getElementById('regBtn');
  btn.disabled = true; btn.textContent = 'Creandoâ€¦';
  document.getElementById('regErr').style.display = 'none';
  try {
    const r = await fetch(`${SERVER}/api/auth/register`, {
      method: 'POST', credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password: pass }),
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Error al registrar');
    closeRegister();
    document.getElementById('loginEmail').value = email;
    document.getElementById('loginPass').value = pass;
    toast('âœ… Cuenta creada. Iniciando sesiÃ³nâ€¦');
    await doLogin();
  } catch(e) { showRegErr(e.message); }
  finally { btn.disabled = false; btn.innerHTML = 'Crear cuenta â†’'; }
}

async function doLogout() {
  try { await trpc('auth.logout', {}, true); } catch(_) {}
  currentUser = null; convs = []; currentConvId = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginMask').style.display = 'flex';
  setServerStatus(false);
}

function onLoginOk(user) {
  currentUser = user;
  document.getElementById('loginMask').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('userNameEl').textContent = user.name || user.email || 'Usuario';
  document.getElementById('userAv').textContent = (user.name || user.email || 'U')[0].toUpperCase();
  setServerStatus(true);
  loadConvs();
}

function showErr(m) { const e = document.getElementById('loginErr'); e.textContent = m; e.style.display = 'block'; }
function hideErr() { document.getElementById('loginErr').style.display = 'none'; }
function showRegErr(m) { const e = document.getElementById('regErr'); e.textContent = m; e.style.display = 'block'; }
function showRegister() { document.getElementById('registerModal').style.display = 'flex'; }
function closeRegister(e) { if (!e || e.target === document.getElementById('registerModal')) document.getElementById('registerModal').style.display = 'none'; }

// Auto-login
(async () => {
  try {
    const me = await trpc('auth.me');
    if (me?.id || me?.email) { onLoginOk(me); return; }
  } catch(_) {}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONVERSATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadConvs() {
  try {
    const data = await trpc('chat.getConversations');
    convs = data || [];
    renderConvs(convs);
    if (convs.length && !currentConvId) selectConv(convs[0]);
  } catch(_) {}
}

function renderConvs(list) {
  const el = document.getElementById('convList');
  if (!list.length) { el.innerHTML = '<div style="font-family:var(--mono);font-size:11px;color:var(--muted);padding:10px 8px">Sin conversaciones</div>'; return; }
  const now = Date.now(), day = 86400000;
  const g = { 'Hoy': [], 'Ayer': [], 'Anteriores': [] };
  list.forEach(c => {
    const d = new Date(c.createdAt || c.updated_at || now); d.setHours(0,0,0,0);
    const n = new Date(); n.setHours(0,0,0,0);
    if (+d === +n) g['Hoy'].push(c);
    else if (+d >= +n - day) g['Ayer'].push(c);
    else g['Anteriores'].push(c);
  });
  let html = '';
  for (const [label, items] of Object.entries(g)) {
    if (!items.length) continue;
    html += `<div class="conv-group">${label}</div>`;
    items.forEach(c => {
      const active = c.id === currentConvId ? ' active' : '';
      const t = escHtml(c.title || c.name || `Chat #${c.id}`);
      html += `<div class="conv-item${active}" onclick="selectConvById(${c.id})">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" style="opacity:.4;flex-shrink:0"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span class="conv-title">${t}</span>
        <span class="conv-time">${new Date(c.createdAt||Date.now()).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}</span>
      </div>`;
    });
  }
  el.innerHTML = html;
}

function filterConvs(q) { renderConvs(!q ? convs : convs.filter(c => (c.title||c.name||'').toLowerCase().includes(q.toLowerCase()))); }

async function selectConvById(id) { const c = convs.find(x => x.id === id); if (c) await selectConv(c); }

async function selectConv(c) {
  currentConvId = c.id;
  document.getElementById('convName').value = c.title || c.name || `Chat #${c.id}`;
  clearMsgs();
  renderConvs(convs);
  try {
    const msgs = await trpc('chat.getMessages', { conversationId: c.id });
    msgs.forEach(m => appendMsg(m.role, m.content));
    scrollBottom();
  } catch(_) {}
}

async function newChat() {
  currentConvId = null;
  document.getElementById('convName').value = 'Nueva conversaciÃ³n';
  clearMsgs();
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('msgInput').focus();
}

async function saveConvName(name) {
  document.getElementById('convName').setAttribute('readonly', '');
  if (!currentConvId || !name.trim()) return;
  const c = convs.find(x => x.id === currentConvId);
  if (c) { c.title = name.trim(); renderConvs(convs); }
  try { await trpc('chat.renameConversation', { conversationId: currentConvId, title: name.trim() }, true); } catch(_) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearMsgs() {
  const a = document.getElementById('msgsArea');
  [...a.children].forEach(el => { if (el.id !== 'emptyState') el.remove(); });
  document.getElementById('emptyState').style.display = 'flex';
}

function appendMsg(role, content, steps = []) {
  document.getElementById('emptyState').style.display = 'none';
  const area = document.getElementById('msgsArea');
  const isUser = role === 'user';
  const time = new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });

  let toolsHtml = '';
  if (steps.length) {
    const toolSteps = steps.filter(s => s.type === 'tool_call' || s.type === 'tool_result');
    if (toolSteps.length) {
      const rows = toolSteps.filter(s => s.type === 'tool_call').map(s =>
        `<div class="tool-row"><span class="tool-icon">âš™ï¸</span><span><span class="tool-name">${escHtml(s.toolName||'')}</span> <span class="tool-result">âœ“</span></span></div>`
      ).join('');
      toolsHtml = `<div class="tools-wrap">
        <button class="tools-hd" onclick="this.parentElement.querySelector('.tools-body').style.display=this.parentElement.querySelector('.tools-body').style.display==='none'?'flex':'none';this.querySelector('.arr').textContent=this.querySelector('.arr').textContent==='â–¶'?'â–¼':'â–¶'">
          <span class="arr">â–¶</span> ${toolSteps.filter(s=>s.type==='tool_call').length} herramienta(s)
        </button>
        <div class="tools-body" style="display:none">${rows}</div>
      </div>`;
    }
  }

  const div = document.createElement('div');
  div.className = `msg ${isUser ? 'user' : 'ai'}`;
  div.innerHTML = `
    <div class="msg-av">${isUser ? (currentUser?.name||'U')[0].toUpperCase() : 'â¬¡'}</div>
    <div class="msg-body">
      <div class="msg-meta">${isUser ? 'TÃº' : 'Manus AI'} Â· ${time}</div>
      ${toolsHtml}
      <div class="bubble">${isUser ? escHtml(content) : mdToHtml(content)}</div>
    </div>`;
  area.appendChild(div);
  scrollBottom();
}

function appendTyping() {
  document.getElementById('emptyState').style.display = 'none';
  const d = document.createElement('div');
  d.id = 'typingMsg'; d.className = 'msg ai';
  d.innerHTML = `<div class="msg-av">â¬¡</div><div class="msg-body"><div class="msg-meta">Manus AI Â· procesando</div><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>`;
  document.getElementById('msgsArea').appendChild(d);
  scrollBottom();
}
function removeTyping() { document.getElementById('typingMsg')?.remove(); }
function scrollBottom() { const a = document.getElementById('msgsArea'); a.scrollTop = a.scrollHeight; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMsg() {
  const ta = document.getElementById('msgInput');
  const text = ta.value.trim();
  if (!text || busy) return;
  busy = true; ta.value = ''; autoResize(ta);
  document.getElementById('sendBtn').disabled = true;
  appendMsg('user', text);
  appendTyping();
  try {
    const r = await trpc('chat.sendMessage', { conversationId: currentConvId || undefined, message: text }, true);
    removeTyping();
    if (r.conversationId && !currentConvId) { currentConvId = r.conversationId; await loadConvs(); }
    appendMsg('assistant', r.answer, r.steps || []);
  } catch(e) {
    removeTyping();
    appendMsg('assistant', `âš ï¸ Error: ${e.message}`);
  } finally {
    busy = false;
    document.getElementById('sendBtn').disabled = false;
    ta.focus();
  }
}

function sendChip(el) {
  document.getElementById('msgInput').value = el.textContent.replace(/^[^\s]+\s/, '').trim();
  document.getElementById('msgInput').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openExport()  { document.getElementById('exportModal').style.display = 'flex'; }
function closeExport(e){ if (!e || e.target === document.getElementById('exportModal')) document.getElementById('exportModal').style.display = 'none'; }

async function doExport(fmt) {
  document.getElementById('exportModal').style.display = 'none';
  if (!currentConvId) { toast('âŒ Sin conversaciÃ³n activa', true); return; }
  try {
    const msgs = await trpc('chat.getMessages', { conversationId: currentConvId });
    let content = '', mime = 'text/plain', ext = fmt;
    if (fmt === 'json')      { content = JSON.stringify({ conversationId: currentConvId, messages: msgs }, null, 2); mime = 'application/json'; }
    else if (fmt === 'txt')  { content = msgs.map(m => `[${m.role.toUpperCase()}]\n${m.content}`).join('\n\n---\n\n'); }
    else                     { content = `# ConversaciÃ³n #${currentConvId}\n\n` + msgs.map(m => `## ${m.role === 'user' ? 'ğŸ‘¤ TÃº' : 'ğŸ¤– Manus AI'}\n\n${m.content}`).join('\n\n---\n\n'); }
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type: mime }));
    a.download = `manus-conv-${currentConvId}.${ext}`; a.click();
    toast(`âœ… Exportado como .${fmt}`);
  } catch(e) { toast('âŒ Error: ' + e.message, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function mdToHtml(md) {
  return md
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```(\w*)\n([\s\S]*?)```/g, (_,l,c) => `<pre><code>${c.trim()}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
    .replace(/\n\n/g, '<br/><br/>')
    .replace(/\n/g, '<br/>');
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 160) + 'px'; }
function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function toast(msg, isErr = false) {
  document.querySelector('.toast')?.remove();
  const t = document.createElement('div');
  t.className = 'toast' + (isErr ? ' err' : ''); t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.classList.add('hide'); setTimeout(() => t.remove(), 300); }, 3000);
}

function showShortcuts() { document.getElementById('scModal').style.display = 'flex'; }
function closeModal(id, e) { if (!e || e.target === document.getElementById(id)) document.getElementById(id).style.display = 'none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  const mod = e.ctrlKey || e.metaKey;
  if (e.key === 'Escape') { ['exportModal','scModal','registerModal'].forEach(id => document.getElementById(id).style.display = 'none'); }
  if (mod && e.key === 'n') { e.preventDefault(); newChat(); }
  if (mod && e.key === 'b') { e.preventDefault(); toggleSidebar(); }
  if (mod && e.key === 'k') { e.preventDefault(); document.getElementById('searchConv').focus(); }
  if (mod && e.key === 'e') { e.preventDefault(); openExport(); }
  if (mod && e.key === '/') { e.preventDefault(); showShortcuts(); }
});
</script>
</body>
</html>
